---
output: html_document
title: metabolomic - paper
---

## Initialization with data
### Read the data from the excel sheet

```{r}
library(readxl)
data <- read_excel(
    "Input/Datenbank_Steroide_gruppiert_230421.xlsx",
    skip = 1, sheet = "Steroids", col_names = TRUE)
```

```{r}
library(dplyr)

dat1 <- data.frame(data, row.names = data$"Pat.-Nr.")

# Remove the Pat.-Nr., Sex and the Age
dat1 <- dat1 %>% select(-1, -2, -3)
``` 

### Removing non applicable data points
```{r}
# Function to Remove all 'NA' from the data
replacezero <- function(x) "[<-"(x, !x | is.na(x), min(x[x > 0],na.rm = TRUE) / 2)

# apply the function to our data, renaming it to 'dat2' in the process
dat2 <- as.data.frame(t(apply(dat1, 1, replacezero)))


sum(is.na(dat2))
```

## Transform data to logarithmic with base 2

```{r}
logdata <- log(dat2, 2)

# Function for pareto scaling
paretoscale <- function(z) {
  rowmean <- apply(z, 1, mean) # row means
  rowsd <- apply(z, 1, sd)  # row standard deviation
  rowsqrtsd <- sqrt(rowsd) # sqrt of sd
  rv <- sweep(z, 1, rowmean,"-")  # mean center
  rv <- sweep(rv, 1, rowsqrtsd, "/")  # dividing by sqrtsd
  return(rv)
}

# Pareto scale log transformed data
logdata.pareto <- scale(paretoscale(logdata))

boxplot(logdata.pareto)
```

## Principal Component analysis

```{r}
pca <- prcomp(t(logdata.pareto), center=F, scale=F)

# Display

plot(pca)
biplot(pca)

# Make a simple scores plot
plot(pca$x[,1], pca$x[,2], type='p', cex=0, pch=20, main="Scores Plot", xlab="PC1", ylab="PC2")
text(pca$x[,1], pca$x[,2], labels=rownames(pca$x), cex=1.0)
abline(h=0, v=0, col="red")

# Make a simple loadings plot (variance among variables)
plot(pca$rotation[,1], pca$rotation[,2], type='p', cex=0.5, pch=20,main="Loadings Plot", xlab="PC1", ylab="PC2")
abline(h=0, v=0, col="red")
```

```{r}
# Create a container called "results" for PCA results
results <- summary(pca)

names(results)

# Extract PCA results into data frames

scree.data <- as.data.frame(results$importance)
score.data <- as.data.frame(results$x)
loadings.data <- as.data.frame(results$rotation)

plot(loadings.data$PC1, loadings.data$PC2)
pvalue <- 0.05
abline(v=pvalue, col="red")
abline(v=-pvalue, col="red")
abline(h=pvalue, col="red")
abline(h=-pvalue, col="red")

# Make a new data frame with PC1, PC2, and PC3 loadings
loadings.PC1.PC2 <- loadings.data[,1:3]
loadings.PC1.PC2[1:6,1:3]  # look at the first few rows

# subset significant loadings
loadings.sig <- subset(loadings.PC1.PC2,
                       PC1 > pvalue | PC1 < -pvalue |
                         PC2 > pvalue | PC2 < -pvalue)

# sanity check - plot the results
plot(loadings.sig$PC1, loadings.sig$PC2)

# logdata.pareto.subset <- subset(logdata.pareto, rownames(logdata.pareto) %in% rownames(loadings.sig))
```

```{r}
####################################################
# Heatmaps
####################################################

library(gplots)
heatmap.2(as.matrix(logdata.pareto), cexRow=0.5, cexCol=0.5 )

```

## Clustering

```{r}
# library(factoextra)
library(cluster)
library(ggplot2)

gap_stat <- clusGap(logdata.pareto,
                    FUN = kmeans,
                    K.max = 5)

# fviz_gap_stat(gap_stat)

result <- (clara(logdata.pareto, 3))

# fviz_cluster(result, data = logdata.pareto)

```

```{r}
is.data.frame(logdata.pareto)
```

```{r}
library(tibble)
clustered_data <- as.data.frame(logdata.pareto) %>% add_column(cluster = result$clustering)
```

```{r}
boxplot(clustered_data[clustered_data$cluster == 2,])
```

```{r}
library(gridExtra)
plot_list <- list()

for (cluster in unique(clustered_data$cluster)) {
  plot_list[[cluster]] <- boxplot(clustered_data[clustered_data$cluster == cluster,], main=cluster)
  plot
}
plot_grob <- arrangeGrob(grobs=plot_list)
grid.arrange(plot_grob)
# plot_grob
```


```{r}
plot(rep(10,30), rep(10,30), type="l", xlab="Metabolite", ylab="Concentration", main="Cluster 1")

```
```{r}

library(ggplot2)

x <- data.frame('One' = c(0, 4, 17), 'Two' = c(10, 20, 39), 'Three' = c(19, 3, 3))
# x <- melt(x)

plt <- ggplot(data = x, aes(x = 1, y = 2))
plt + geom_boxplot() + theme_minimal() + labs(x = "Title", y = "x")

```